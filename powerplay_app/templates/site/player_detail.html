{# file: powerplay_app/templates/site/player_detail.html #}
{% extends "site/base.html" %}
{% load static %}

{% block title %}{{ player.first_name }} {{ player.last_name }} | Hráči | {% if primary_team %}{{ primary_team.name }} | {% endif %}PowerPlay{% endblock %}
{% block crumbs %}Domů / <a href="{% url 'site:players' %}" class="link">Hráči</a> / {{ player.first_name }} {{ player.last_name }}{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'site/css/player_detail.css' %}">
{% endblock %}

{% block content %}
<div class="p-player">

  {# ——— HERO s fotkou a kontakty ——— #}
  <section class="player-hero">
    <div class="container player-hero__inner">
      <div class="player-hero__media">
        <img class="player-hero__photo"
             src="{{ player.photo_url }}"
             alt="{{ player.first_name }} {{ player.last_name }}"
             width="240" height="240">
      </div>

      <div class="player-hero__body">
        <div class="player-hero__top">
          {% if player.jersey_number %}
            <span class="jersey jersey--xl">#{{ player.jersey_number }}</span>
          {% endif %}
          <h1 class="player-hero__name">{{ player.first_name }} {{ player.last_name }}</h1>
        </div>

        <div class="player-hero__meta">
          <span class="badge">{{ player.get_position_display }}</span>
          {% if age %}
            <span class="dot" aria-hidden="true"></span>
            <span class="muted">{{ age }} let</span>
          {% endif %}
          {% if player.country %}
            <span class="dot" aria-hidden="true"></span>
            <span class="muted">{{ player.country.name }}</span>
          {% endif %}
        </div>

        <div class="player-hero__contacts">
          {% if player.email %}
            <a class="link" href="mailto:{{ player.email }}">{{ player.email }}</a>
          {% endif %}
          {% if player.phone %}
            {% if player.email %}<span class="dot" aria-hidden="true"></span>{% endif %}
            <a class="link" href="tel:{{ player.phone|cut:" " }}">{{ player.phone }}</a>
          {% endif %}
        </div>

        <div class="player-hero__actions">
          <a class="pill" href="{% url 'site:players' %}#player-{{ player.id }}">Zobrazit kartu</a>
          {% if player.email %}<a class="pill" href="mailto:{{ player.email }}">Napsat</a>{% endif %}
        </div>
      </div>
    </div>
  </section>

  {# ——— STATISTIKY ——— #}
  <section class="section section--stats">
    <div class="container">
      <h2 class="section__title">Statistiky (sezóna)</h2>

      {# Pilulky filtru soutěže (Liga/Turnaj/Přátelské/Vše) #}
      {% url 'site:player_detail' pk=player.pk as me_url %}
      <div class="filters mt-2" role="tablist" aria-label="Filtr soutěže">
        <a class="filter__link {% if season_meta.cmp == 'league' %}is-active{% endif %}" href="{{ me_url }}?cmp=league">Liga</a>
        <a class="filter__link {% if season_meta.cmp == 'tournament' %}is-active{% endif %}" href="{{ me_url }}?cmp=tournament">Turnaj</a>
        <a class="filter__link {% if season_meta.cmp == 'friendly' %}is-active{% endif %}" href="{{ me_url }}?cmp=friendly">Přátelské</a>
        <a class="filter__link {% if season_meta.cmp == 'all' %}is-active{% endif %}" href="{{ me_url }}?cmp=all">Vše</a>
      </div>

      {# Tabulka zápasů #}
      {% if game_rows %}
        <table class="stats-table mt-2">
          <thead>
            <tr>
              <th>Datum</th>
              <th>Soutěž</th>
              <th>Soupeř</th>
              <th>Výsledek</th>
              {% if is_goalie %}
                <th class="num">GA</th>
                <th class="num">G</th>
                <th class="num">A</th>
                <th class="num">PIM</th>
              {% else %}
                <th class="num">G</th>
                <th class="num">A</th>
                <th class="num">PTS</th>
                <th class="num">PIM</th>
              {% endif %}
            </tr>
          </thead>
          <tbody>
            {% for r in game_rows %}
              <tr>
                <td>
                  {# Proklik na detail zápasu – fallback slug pro staré zápasy #}
                  {% if r.game.slug %}
                    <a class="link" href="{% url 'site:game_detail' pk=r.game.pk slug=r.game.slug %}">
                      {{ r.game.starts_at|date:"j. n. Y" }}
                    </a>
                  {% else %}
                    <a class="link" href="{% url 'site:game_detail' pk=r.game.pk slug='detail' %}">
                      {{ r.game.starts_at|date:"j. n. Y" }}
                    </a>
                  {% endif %}
                </td>
                <td>
                  {% if r.game.get_competition_display %}
                    {{ r.game.get_competition_display }}
                    {# — doplněk: název ligy/turnaje — #}
                    {% if r.game.competition == 'league' %}
                      {% if r.game.league and r.game.league.name %}
                        <span class="muted">— {{ r.game.league.name }}</span>
                      {% elif season_meta.league %}
                        <span class="muted">— {{ season_meta.league.name }}</span>
                      {% endif %}
                    {% elif r.game.competition == 'tournament' %}
                      {% if r.game.tournament and r.game.tournament.name %}
                        <span class="muted">— {{ r.game.tournament.name }}</span>
                      {% elif r.game.tournament_name %}
                        <span class="muted">— {{ r.game.tournament_name }}</span>
                      {% else %}
                        <span class="muted">—</span>
                      {% endif %}
                    {% endif %}
                  {% else %}—{% endif %}
                </td>
                <td>{% if r.is_away %}@ {% endif %}{{ r.opponent.name }}</td>
                <td>
                  {% if r.result_letter %}
                    <span class="result result--{{ r.result_letter }}">{{ r.result_letter }}</span>
                    <span class="muted">({{ r.game.score_home }} : {{ r.game.score_away }})</span>
                  {% else %}—{% endif %}
                </td>

                {% if is_goalie %}
                  <td class="num">{{ r.ga }}</td>
                  <td class="num">{{ r.g }}</td>
                  <td class="num">{{ r.a }}</td>
                  <td class="num">{{ r.pim }}</td>
                {% else %}
                  <td class="num">{{ r.g }}</td>
                  <td class="num">{{ r.a }}</td>
                  <td class="num">{{ r.pts }}</td>
                  <td class="num">{{ r.pim }}</td>
                {% endif %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p class="muted mt-2">Bez zápasů v tomto filtru.</p>
      {% endif %}

      {# Souhrnné chips #}
      {% if is_goalie %}
        <div class="stat-line">
          <span class="stat"><span class="k">GP</span>  <span class="v">{{ stats.gp|default:0 }}</span></span>
          <span class="stat"><span class="k">GA</span>  <span class="v">{{ stats.ga|default:0 }}</span></span>
          <span class="stat"><span class="k">G</span>   <span class="v">{{ stats.g|default:0 }}</span></span>
          <span class="stat"><span class="k">A</span>   <span class="v">{{ stats.a|default:0 }}</span></span>
          <span class="stat"><span class="k">PIM</span> <span class="v">{{ stats.pim|default:0 }}</span></span>
        </div>
      {% else %}
        <div class="stat-line">
          <span class="stat"><span class="k">GP</span>  <span class="v">{{ stats.gp|default:0 }}</span></span>
          <span class="stat"><span class="k">G</span>   <span class="v">{{ stats.g|default:0 }}</span></span>
          <span class="stat"><span class="k">A</span>   <span class="v">{{ stats.a|default:0 }}</span></span>
          <span class="stat"><span class="k">PTS</span> <span class="v">{{ stats.pts|default:0 }}</span></span>
          <span class="stat"><span class="k">PIM</span> <span class="v">{{ stats.pim|default:0 }}</span></span>
        </div>
      {% endif %}
    </div>
  </section>
</div>
{% endblock %}
